# Document Organizer - Docker Compose Configuration
#
# Quick Start:
#   docker compose up ui
#   # Then open http://localhost:8501 and configure paths in Settings
#
# Access Options:
#   # Mount a specific folder:
#   DOCUMENTS_PATH=/path/to/folder docker compose up ui
#
#   # Mount entire home directory:
#   DOCUMENTS_PATH=$HOME docker compose up ui
#
#   # Mount root filesystem (full access to all files):
#   DOCUMENTS_PATH=/ docker compose up ui
#
#   # Windows (PowerShell):
#   $env:DOCUMENTS_PATH=$env:USERPROFILE; docker compose up ui
#
# Run preprocessing in background:
#   docker compose up -d preprocess

services:
  # Base service configuration (not run directly)
  base: &base
    build:
      context: .
      args:
        INSTALL_PROVIDERS: anthropic,openai
    env_file:
      - path: .env
        required: false
    volumes:
      # Mount filesystem - set DOCUMENTS_PATH to control access scope
      # Examples: DOCUMENTS_PATH=$HOME, DOCUMENTS_PATH=/, DOCUMENTS_PATH=/Users
      - ${DOCUMENTS_PATH:-./documents}:/documents
      # Persist settings between container restarts
      - docorg-settings:/home/appuser/.config/DocumentOrganizer
    environment:
      # API keys and settings from .env or command line
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - AI_PROVIDER=${AI_PROVIDER:-auto}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Docker paths - use /documents mount point
      # Configure actual paths in Settings UI after startup
      - OUTPUT_DIR=${OUTPUT_DIR:-/documents/jd_documents}
      - INBOX_DIR=${INBOX_DIR:-/documents/inbox}
    restart: unless-stopped

  # Streamlit Web UI
  ui:
    <<: *base
    container_name: document-organizer-ui
    ports:
      - "${UI_PORT:-8501}:8501"
    command: ["ui"]

  # Document preprocessor (watch mode)
  preprocess:
    <<: *base
    container_name: document-organizer-preprocess
    command: ["preprocess"]

  # One-time document processing
  organizer:
    <<: *base
    profiles:
      - cli
    command: ["--once"]

  # Development with hot reload
  dev:
    <<: *base
    profiles:
      - dev
    volumes:
      - ${DOCUMENTS_PATH:-./documents}:/documents
      - docorg-settings:/home/appuser/.config/DocumentOrganizer
      - .:/app:ro
    command: ["ui"]
    ports:
      - "${UI_PORT:-8501}:8501"

volumes:
  docorg-settings:
